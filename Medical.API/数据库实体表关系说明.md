# 医疗系统数据库实体表关系说明

## 一、用户与权限管理模块

### 1. UserTypeDictionary（用户类型字典表）
- **用途**：存储用户类型枚举（1=System系统用户, 2=Doctor医生, 3=Patient患者）
- **关系**：User.UserTypeId → UserTypeDictionary.Id (多对一)

### 2. Users（用户表）
- **用途**：系统基础用户表，存储用户名、密码、手机号、邮箱等基础信息（敏感信息加密存储）
- **主要字段**：Username, PasswordHash, PhoneNumber, Email, AvatarUrl, Role, UserTypeId, IsActive, IsDeleted
- **关系**：
  - UserTypeId → UserTypeDictionary.Id (多对一)
  - 一对多：UserRoles, Posts, PostComments, PostLikes

### 3. Patients（患者信息表）
- **用途**：患者详细信息表，存储真实姓名、身份证号、过敏史、既往病史等（敏感信息加密存储）
- **主要字段**：UserId, RealName, Gender, DateOfBirth, IdCardNumber, PhoneNumber, AllergyHistory, MedicalHistory, FamilyHistory, BMI
- **关系**：
  - UserId → Users.Id (一对一，唯一索引)
  - 一对多：FamilyMembers, Consultations, Questions, Answers, Prescriptions, VisitRecords, ExaminationReports, DoctorReviews
  - 多对多：DoctorPatients (通过 DoctorPatient 中间表)

### 4. Doctors（医生表）
- **用途**：医生信息表，存储医生姓名、职称、擅长领域、医院、评分等
- **主要字段**：DepartmentId, Name, Title, Specialty, Hospital, Introduction, AvatarUrl, Rating, ConsultationCount, FollowerCount, TotalReadCount, IsRecommended
- **关系**：
  - DepartmentId → Departments.Id (多对一)
  - 一对多：Schedules, Consultations, Reviews, PatientSupportGroups
  - 多对多：DoctorPatients (通过 DoctorPatient 中间表)

### 5. Departments（科室表）
- **用途**：医院科室信息表
- **主要字段**：Name, Description, IconUrl, SortOrder, IsHot
- **关系**：
  - 一对多：Doctors, DiseaseCategories

### 6. DiseaseCategory（疾病分类表）
- **用途**：疾病分类信息
- **关系**：
  - DepartmentId → Departments.Id (多对一)

### 7. FamilyMember（家庭成员表）
- **用途**：患者家庭成员信息
- **关系**：
  - PatientId → Patients.Id (多对一，级联删除)

### 8. DoctorPatient（医生-患者关联表）
- **用途**：医生与患者的多对多关系中间表
- **关系**：
  - DoctorId → Doctors.Id (多对一，级联删除)
  - PatientId → Patients.Id (多对一，级联删除)
  - 唯一索引：(DoctorId, PatientId)

### 9. UserDoctorSubscription（用户-医生订阅表）
- **用途**：用户订阅医生关系（多对多）
- **关系**：
  - UserId → Users.Id (多对一，级联删除)
  - DoctorId → Doctors.Id (多对一，级联删除)
  - 唯一索引：(UserId, DoctorId)

---

## 二、角色与权限管理模块

### 10. Roles（角色表）
- **用途**：系统角色定义（SuperAdmin, Admin等）
- **主要字段**：Code, Name, Description
- **关系**：
  - 一对多：UserRoles, RolePermissions
  - 唯一索引：Code, Name

### 11. Permissions（权限表）
- **用途**：系统权限定义（view, create, update, delete等）
- **主要字段**：Code, Name, Description, MenuUrl, PermissionType
- **关系**：
  - PermissionTypeId → PermissionTypeDictionary.Id (多对一)
  - 一对多：RolePermissions
  - 唯一索引：Code

### 12. PermissionTypeDictionary（权限类型字典表）
- **用途**：权限类型枚举（view, create, update, delete）
- **关系**：Permissions.PermissionTypeId → PermissionTypeDictionary.Id (多对一)

### 13. UserRoles（用户-角色关联表）
- **用途**：用户与角色的多对多关系中间表
- **关系**：
  - UserId → Users.Id (多对一，级联删除)
  - RoleId → Roles.Id (多对一，限制删除)
  - 唯一索引：(UserId, RoleId)

### 14. RolePermissions（角色-权限关联表）
- **用途**：角色与权限的多对多关系中间表
- **关系**：
  - RoleId → Roles.Id (多对一，级联删除)
  - PermissionId → Permissions.Id (多对一，限制删除)
  - 唯一索引：(RoleId, PermissionId)

### 15. MenuPermissions（菜单权限表）
- **用途**：菜单访问权限配置，控制不同角色可访问的菜单项
- **主要字段**：MenuKey, RoleCode
- **关系**：通过 RoleCode 关联到 Roles.Code
  - 唯一索引：(MenuKey, RoleCode)

---

## 三、咨询与问诊模块

### 16. Consultations（咨询表）
- **用途**：患者与医生的咨询记录
- **主要字段**：PatientId, DoctorId, ConsultationType, Price, Status, StartTime, EndTime
- **关系**：
  - PatientId → Patients.Id (多对一，限制删除)
  - DoctorId → Doctors.Id (多对一，限制删除)
  - 一对多：Messages
  - 索引：Status, (DoctorId, Status)

### 17. ConsultationMessage（咨询消息表）
- **用途**：咨询过程中的消息记录（文本、图片、视频、语音、文件）
- **主要字段**：ConsultationId, SenderId, MessageType, Content, AttachmentUrl
- **关系**：
  - ConsultationId → Consultations.Id (多对一，级联删除)

### 18. Questions（问题表）
- **用途**：患者提问记录
- **关系**：
  - PatientId → Patients.Id (多对一，限制删除)
  - 一对多：Answers

### 19. Answers（回答表）
- **用途**：医生或患者对问题的回答
- **关系**：
  - QuestionId → Questions.Id (多对一，级联删除)
  - PatientId → Patients.Id (多对一，限制删除)

### 20. DoctorSchedule（医生排班表）
- **用途**：医生出诊时间安排
- **关系**：
  - DoctorId → Doctors.Id (多对一，级联删除)

### 21. DoctorReview（医生评价表）
- **用途**：患者对医生的评价和评分
- **关系**：
  - PatientId → Patients.Id (多对一，限制删除)
  - DoctorId → Doctors.Id (多对一)

---

## 四、诊疗管理模块

### 22. VisitRecords（就诊记录表）
- **用途**：患者线下就诊记录
- **主要字段**：PatientId, DoctorId, VisitDate, ConsultationId, Symptoms, Diagnosis, Treatment
- **关系**：
  - PatientId → Patients.Id (多对一，限制删除)
  - DoctorId → Doctors.Id (多对一，限制删除)
  - ConsultationId → Consultations.Id (可选关联)

### 23. ExaminationReports（检查报告表）
- **用途**：患者检查报告记录
- **主要字段**：PatientId, DoctorId, ExaminationDate, ReportDate, ExaminationType, ReportContent
- **关系**：
  - PatientId → Patients.Id (多对一，限制删除)
  - DoctorId → Doctors.Id (多对一，限制删除)

### 24. Prescriptions（处方表）
- **用途**：医生开具的处方记录
- **主要字段**：PatientId, DoctorId, PrescriptionDate, Status
- **关系**：
  - PatientId → Patients.Id (多对一，限制删除)
  - DoctorId → Doctors.Id (多对一，限制删除)
  - 一对多：PrescriptionMedicines

### 25. PrescriptionMedicine（处方药品表）
- **用途**：处方中的具体药品明细
- **关系**：
  - PrescriptionId → Prescriptions.Id (多对一，级联删除)
  - MedicineId → Medicines.Id (多对一)

### 26. Medicines（药品表）
- **用途**：药品基础信息（通用名、商品名、规格、生产厂家等）
- **关系**：
  - 一对多：PrescriptionMedicines

---

## 五、知识活动模块

### 27. HealthKnowledge（健康知识表）
- **用途**：健康知识文章（标题、分类、作者、来源、封面、摘要、内容、阅读量、收藏量）
- **主要字段**：Title, Category, Author, Source, CoverImageUrl, Summary, Content, ReadCount, FavoriteCount, IsHot, IsRecommended
- **关系**：
  - 多对多：UserHealthKnowledgeFavorites (通过 UserHealthKnowledgeFavorite 中间表)

### 28. UserHealthKnowledgeFavorite（用户健康知识收藏表）
- **用途**：用户收藏健康知识的关系表（多对多）
- **关系**：
  - UserId → Users.Id (多对一，级联删除)
  - HealthKnowledgeId → HealthKnowledge.Id (多对一，级联删除)
  - 唯一索引：(UserId, HealthKnowledgeId)

### 29. Activities（活动表）
- **用途**：健康活动信息（标题、类型、封面、描述、开始时间、结束时间）
- **主要字段**：Title, ActivityType, CoverImageUrl, Description, StartTime, EndTime, SortOrder

---

## 六、患友会模块

### 30. PatientSupportGroup（患友会表）
- **用途**：医生创建的患友会群组
- **关系**：
  - DoctorId → Doctors.Id (多对一，级联删除)
  - 一对一：GroupRules
  - 一对多：Posts

### 31. GroupRules（患友会规则表）
- **用途**：患友会的规则和说明
- **关系**：
  - PatientSupportGroupId → PatientSupportGroups.Id (一对一，级联删除)

### 32. Posts（发帖表）
- **用途**：用户在患友会中发布的帖子
- **主要字段**：PatientSupportGroupId, UserId, Title, Content, ImageUrls, LikeCount, CommentCount
- **关系**：
  - PatientSupportGroupId → PatientSupportGroups.Id (多对一，级联删除)
  - UserId → Users.Id (多对一，限制删除)
  - 一对多：Comments, Likes

### 33. PostComment（评论表）
- **用途**：帖子评论（支持回复评论）
- **关系**：
  - PostId → Posts.Id (多对一，级联删除)
  - UserId → Users.Id (多对一，限制删除)
  - ParentCommentId → PostComment.Id (自引用，多对一，限制删除)
  - 一对多：Replies (子评论)

### 34. PostLike（点赞表）
- **用途**：用户对帖子的点赞记录（多对多）
- **关系**：
  - PostId → Posts.Id (多对一，级联删除)
  - UserId → Users.Id (多对一，限制删除)
  - 唯一索引：(PostId, UserId)

---

## 七、药品管理模块

### 35. DrugCategory（药品分类表）
- **用途**：药品分类（支持树形结构，自引用）
- **主要字段**：CategoryName, ParentId, SortOrder
- **关系**：
  - ParentId → DrugCategory.Id (自引用，多对一，限制删除)
  - 一对多：Children, Drugs
  - 唯一索引：CategoryName

### 36. Drugs（药品信息表）
- **用途**：药品基础信息（通用名、商品名、规格、生产厂家、批准文号等）
- **主要字段**：CategoryId, CommonName, TradeName, Specification, Manufacturer, ApprovalNumber, StorageCondition
- **关系**：
  - CategoryId → DrugCategories.Id (多对一，限制删除)
  - 一对多：Inventories, StockInLines
  - 唯一索引：ApprovalNumber
  - 索引：CommonName, Manufacturer

### 37. DrugInventory（药品库存表）
- **用途**：药品库存信息（按仓库位置）
- **主要字段**：DrugId, WarehouseLocation, Quantity, ExpiryDate
- **关系**：
  - DrugId → Drugs.Id (多对一，限制删除)
  - 唯一索引：(DrugId, WarehouseLocation)

### 38. DrugStockInHead（药品入库单头表）
- **用途**：药品入库单主表
- **主要字段**：InvoiceNo, OperatorId, OperationTime, Remark
- **关系**：
  - OperatorId → Users.Id (多对一，限制删除)
  - 一对多：Lines
  - 唯一索引：InvoiceNo

### 39. DrugStockInLine（药品入库单行表）
- **用途**：药品入库单明细
- **主要字段**：HeadId, DrugId, Quantity, UnitPrice, BatchNumber, ExpiryDate
- **关系**：
  - HeadId → DrugStockInHeads.Id (多对一，级联删除)
  - DrugId → Drugs.Id (多对一，限制删除)

---

## 八、商城模块

### 40. ProductCategory（商品分类表）
- **用途**：商品分类信息
- **主要字段**：Name, Code, SortOrder, IsEnabled
- **关系**：
  - 一对多：Products
  - 唯一索引：Code

### 41. Products（商品表）
- **用途**：商品基础信息
- **主要字段**：CategoryId, Name, Code, Description, Price, MarketPrice, CoverUrl, IsEnabled, IsVirtual
- **关系**：
  - CategoryId → ProductCategories.Id (多对一，限制删除)
  - 一对多：Specs, CartItems, OrderItems
  - 唯一索引：Code

### 42. ProductSpec（商品规格表）
- **用途**：商品规格信息（如：500g/盒、1000g/盒等）
- **主要字段**：ProductId, SpecName, SpecCode, Price, Stock, Weight, IsDefault
- **关系**：
  - ProductId → Products.Id (多对一，级联删除)
  - 一对多：CartItems, OrderItems
  - 唯一索引：(ProductId, SpecName)

### 43. Carts（购物车表）
- **用途**：用户购物车
- **主要字段**：UserId
- **关系**：
  - UserId → Users.Id (多对一)
  - 一对多：Items
  - 索引：UserId

### 44. CartItems（购物车商品项表）
- **用途**：购物车中的商品明细
- **主要字段**：CartId, ProductId, ProductSpecId, Quantity, Price
- **关系**：
  - CartId → Carts.Id (多对一，级联删除)
  - ProductId → Products.Id (多对一，限制删除)
  - ProductSpecId → ProductSpecs.Id (多对一，限制删除)

### 45. UserAddresses（用户收货地址表）
- **用途**：用户收货地址信息
- **主要字段**：UserId, Consignee, Phone, Province, City, District, AddressLine, IsDefault
- **关系**：
  - UserId → Users.Id (多对一)
  - 索引：UserId

### 46. Orders（订单表）
- **用途**：订单主表
- **主要字段**：UserId, OrderNo, Status, PayStatus, TotalAmount, PayAmount, PayMethod, Consignee, Phone, Province, City, District, AddressLine, IsDropship, DropshipVendor
- **关系**：
  - UserId → Users.Id (多对一)
  - 一对多：Items, Payments, Shipments, Refunds
  - 唯一索引：OrderNo

### 47. OrderItems（订单明细表）
- **用途**：订单商品明细
- **主要字段**：OrderId, ProductId, ProductSpecId, Quantity, UnitPrice, Subtotal
- **关系**：
  - OrderId → Orders.Id (多对一，级联删除)
  - ProductId → Products.Id (多对一，限制删除)
  - ProductSpecId → ProductSpecs.Id (多对一，限制删除)

### 48. Payments（支付记录表）
- **用途**：订单支付记录
- **主要字段**：OrderId, PayMethod, Amount, PayTime, PayTxnId, PayChannelRaw
- **关系**：
  - OrderId → Orders.Id (多对一，级联删除)
  - 索引：OrderId

### 49. ShipCompanies（物流公司表）
- **用途**：物流公司枚举（顺丰、申通、圆通、京东、邮政/EMS等）
- **主要字段**：Name, Code, ContactUrl, Phone, IsEnabled
- **关系**：
  - 一对多：Shipments
  - 唯一索引：Code

### 50. Shipments（发货单表）
- **用途**：订单发货单（支持一单多包裹）
- **主要字段**：OrderId, ShipCompanyId, TrackingNo, PackageIndex, Status, ShippedAt, DeliveredAt
- **关系**：
  - OrderId → Orders.Id (多对一，级联删除)
  - ShipCompanyId → ShipCompanies.Id (多对一，限制删除)
  - 一对多：Tracks
  - 索引：TrackingNo

### 51. ShipmentTracks（物流轨迹表）
- **用途**：物流跟踪记录
- **主要字段**：ShipmentId, StatusText, Location, OccurredAt, RawPayload
- **关系**：
  - ShipmentId → Shipments.Id (多对一，级联删除)
  - 索引：ShipmentId

### 52. Refunds（退款记录表）
- **用途**：订单退款记录（支持部分退款）
- **主要字段**：OrderId, OrderItemId, RefundNo, Amount, Reason, Status, RefundMethod, ChannelRefundNo, InitiatedAt, CompletedAt
- **关系**：
  - OrderId → Orders.Id (多对一，级联删除)
  - OrderItemId → OrderItems.Id (多对一，限制删除，可选)
  - 索引：OrderId

---

## 九、基础数据模块

### 53. Provinces（省份表）
- **用途**：中国省份信息
- **主要字段**：Code, Name, ShortName, SortOrder, IsEnabled
- **关系**：
  - 一对多：Cities
  - 唯一索引：Code

### 54. Cities（城市表）
- **用途**：中国地级市信息
- **主要字段**：ProvinceId, Code, Name, ShortName, SortOrder, IsEnabled
- **关系**：
  - ProvinceId → Provinces.Id (多对一，限制删除)
  - 唯一索引：Code
  - 索引：ProvinceId, Name

### 55. Feedback（反馈投诉表）
- **用途**：用户反馈和投诉记录
- **主要字段**：Status, Content, CreatedAt
- **关系**：无外键关系
  - 索引：Status, CreatedAt

---

## 关系总结

### 核心实体关系链：

1. **用户体系**：
   - UserTypeDictionary → User → Patient/Doctor
   - User → UserRole → Role
   - Role → RolePermission → Permission

2. **患者诊疗链**：
   - Patient → Consultation → ConsultationMessage
   - Patient → VisitRecord → Prescription → PrescriptionMedicine → Medicine
   - Patient → ExaminationReport
   - Patient → Question → Answer

3. **医生关系链**：
   - Department → Doctor → DoctorSchedule
   - Doctor ↔ Patient (通过 DoctorPatient)
   - Doctor → PatientSupportGroup → Post → PostComment/PostLike

4. **商城订单链**：
   - User → Cart → CartItem → Product/ProductSpec
   - User → UserAddress
   - User → Order → OrderItem → Product/ProductSpec
   - Order → Payment
   - Order → Shipment → ShipmentTrack → ShipCompany
   - Order → Refund → OrderItem

5. **药品管理链**：
   - DrugCategory (自引用) → Drug → DrugInventory
   - DrugStockInHead → DrugStockInLine → Drug

6. **知识活动链**：
   - HealthKnowledge ↔ User (通过 UserHealthKnowledgeFavorite)
   - Activity

7. **基础数据链**：
   - Province → City

---

## 删除策略说明

- **Cascade（级联删除）**：删除父记录时自动删除子记录
  - 适用于：家庭成员、咨询消息、处方药品、订单明细、支付记录、发货单、物流轨迹、退款记录等

- **Restrict（限制删除）**：如果存在关联子记录，禁止删除父记录
  - 适用于：患者、医生、科室、商品、药品等核心实体

- **无外键关系**：某些表通过业务逻辑关联，不设置数据库外键约束

